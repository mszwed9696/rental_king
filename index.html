<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rental King API</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 2rem; line-height: 1.45; }
      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      a { color: #1a73e8; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top: 1rem; }
      .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 1rem; }
      button { padding: .5rem .8rem; border: 1px solid #d1d5db; border-radius: 8px; background: #fff; cursor: pointer; }
      button:hover { background: #f8fafc; }
      #out { white-space: pre-wrap; background: #0b1020; color: #d1e7ff; padding: 1rem; border-radius: 8px; overflow: auto; max-height: 50vh; }
      .muted { color: #6b7280; }
    </style>
  </head>
  <body>
    <h1>Rental King API</h1>
    <p class="muted">Vercel serverless endpoints serving listings from a published Google Sheet CSV.</p>

    <div class="grid">
      <div class="card">
        <h3>Endpoints</h3>
        <ul>
          <li><a href="/listings.json" target="_blank">/listings.json</a> (JSON)</li>
          <li><a href="/listings.jsonp?cb=dbg" target="_blank">/listings.jsonp?cb=dbg</a> (JSONP)</li>
          <li><a href="/sanity" target="_blank">/sanity</a> (meta)</li>
        </ul>
      </div>
      <div class="card">
        <h3>Quick Test</h3>
        <p>
          <button id="btn-json">Fetch JSON</button>
          <button id="btn-jsonp">Fetch JSONP</button>
          <button id="btn-sanity">Check Sanity</button>
        </p>
        <div id="out">Ready.</div>
      </div>
      <div class="card">
        <h3>GHL Loader</h3>
        <p>Use the same URL for Map and Grid loaders:</p>
        <pre><code>const API_BASE = window.location.origin;
const url = API_BASE + '/listings.jsonp?cb=' + cb;</code></pre>
        <p class="muted">Callback is sanitized to [A-Za-z0-9_$/.].</p>
      </div>
    </div>

    <script>
      const $ = sel => document.querySelector(sel);
      const out = $('#out');
      function log(o){ out.textContent = typeof o === 'string' ? o : JSON.stringify(o, null, 2); }

      $('#btn-json').onclick = async () => {
        try {
          const r = await fetch('/listings.json');
          const j = await r.json();
          log({ ok: r.ok, count: (j.properties||[]).length, sample: (j.properties||[]).slice(0,2) });
        } catch (e) { log(String(e)); }
      };

      $('#btn-jsonp').onclick = () => {
        const cb = 'dbg_'+Math.random().toString(36).slice(2);
        window[cb] = (data) => {
          log({ ok: true, count: (data.properties||[]).length, sample: (data.properties||[]).slice(0,2) });
          cleanup();
        };
        const s = document.createElement('script');
        s.src = '/listings.jsonp?cb=' + cb;
        s.onerror = () => { log('JSONP load error'); cleanup(); };
        document.body.appendChild(s);
        function cleanup(){ delete window[cb]; s.remove(); }
      };

      $('#btn-sanity').onclick = async () => {
        try {
          const r = await fetch('/sanity');
          const j = await r.json();
          log(j);
        } catch (e) { log(String(e)); }
      };
    </script>
  </body>
  </html>

